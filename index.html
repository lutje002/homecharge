async function processImage() {
  const photoInput = document.getElementById('photoInput');
  const invoiceContainer = document.getElementById('invoiceContainer');
  const loader = document.getElementById('loader');
  const buttonText = document.getElementById('buttonText');

  if (photoInput.files.length > 0) {
    const file = photoInput.files[0];
    
    // Toon loader
    loader.style.display = 'block';
    buttonText.textContent = 'Verwerken...';

    try {
      // Converteer naar base64
      const base64Image = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64String = reader.result.split(',')[1];
          resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const response = await fetch('https://openapi.monica.im/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-74PDyAlNKWSTMSF00qpvh0Z0WuGzpriVmWDBdMAUHED9PSmGLcMCZ4ByElHRwX7ch8wgghmnusYT2Zcb2QLpRbaG_heD'
        },
        body: JSON.stringify({
          model: "gpt-4o",
          messages: [
            {
              role: "user",
              content: [
                {
                  type: "text",
                  text: "Analyseer deze afbeelding van laadsessies en geef de informatie in het volgende JSON formaat terug: {\"sessions\": [{\"date\": \"datum\", \"kWh\": aantal, \"pricePerKWh\": prijs}]}"
                },
                {
                  type: "image",
                  image: base64Image
                }
              ]
            }
          ]
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`HTTP error! status: ${response.status}, message: ${JSON.stringify(errorData)}`);
      }

      const data = await response.json();
      console.log('API Response:', data);

      // Parse response
      let sessions;
      try {
        const contentString = data.choices[0].message.content;
        const parsedContent = JSON.parse(contentString);
        sessions = parsedContent.sessions;
      } catch (e) {
        console.error('Error parsing response:', e);
        throw new Error('Kon de sessie-informatie niet correct verwerken');
      }

      // Update factuur
      const invoiceBody = document.getElementById('invoiceBody');
      invoiceBody.innerHTML = '';

      let totalAmount = 0;

      sessions.forEach(session => {
        const row = document.createElement('tr');
        const amount = session.kWh * session.pricePerKWh;

        row.innerHTML = `
          <td>${formatDate(session.date)}</td>
          <td>Thuisladen elektrische auto</td>
          <td>${session.kWh.toFixed(2)}</td>
          <td>€${session.pricePerKWh.toFixed(3)}</td>
          <td>€${amount.toFixed(2)}</td>
        `;
        
        invoiceBody.appendChild(row);
        totalAmount += amount;
      });

      // Update factuurdetails
      document.getElementById('invoiceNumber').textContent = generateInvoiceNumber();
      document.getElementById('invoiceDate').textContent = formatDate(new Date());
      document.getElementById('invoiceTotal').textContent = '€' + totalAmount.toFixed(2);
      
      // Toon factuur
      invoiceContainer.style.display = 'block';

    } catch (error) {
      console.error('Error:', error);
      alert('Er is een fout opgetreden bij het verwerken van de afbeelding: ' + error.message);
    } finally {
      // Verberg loader
      loader.style.display = 'none';
      buttonText.textContent = 'Genereer Factuur';
    }
  }
}

