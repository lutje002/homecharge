  <!DOCTYPE html>
  <html lang="nl">
  <head>
      <title>NCubed Laadkosten</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      
      <!-- iOS Meta Tags -->
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
      <meta name="apple-mobile-web-app-title" content="NCubed Laadkosten">
      
      <!-- iOS Icon Tags -->
      <link rel="apple-touch-icon" href="https://lutje002.github.io/homecharge/ncubed-power.png">
      <link rel="apple-touch-icon" sizes="152x152" href="https://lutje002.github.io/homecharge/ncubed-power.png">
      <link rel="apple-touch-icon" sizes="167x167" href="https://lutje002.github.io/homecharge/ncubed-power.png">
      <link rel="apple-touch-icon" sizes="180x180" href="https://lutje002.github.io/homecharge/ncubed-power.png">
      
      <!-- iOS Splash Screen Images -->
      <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="ncubed-splash-1290x2796.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="ncubed-splash-1179x2556.png">
      <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="ncubed-splash-1284x2778.png">
      
      <!-- Favicon -->
      <link rel="icon" type="image/png" href="https://lutje002.github.io/homecharge/ncubed-power.png">

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

      <style>
          :root {
              --primary: #E91E63;
              --secondary: #2196F3;
              --success: #4CAF50;
              --danger: #f44336;
              --dark: #333;
              --light: #f5f5f5;
          }

          body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              background-color: var(--light);
          }

          .container {
              max-width: 800px;
              margin: 0 auto;
              background: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }

          .logo-container {
              text-align: center;
              margin: 20px 0;
          }

          .logo {
              width: 100px;
              height: 100px;
          }

          .upload-container {
              border: 2px dashed #ccc;
              padding: 20px;
              text-align: center;
              margin: 20px 0;
              border-radius: 8px;
              transition: all 0.3s ease;
          }

          .dragover {
              background-color: #e1f5fe;
              border-color: var(--primary);
          }

          button {
              background-color: var(--success);
              color: white;
              padding: 10px 20px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              margin: 5px;
              transition: background-color 0.3s ease;
          }

          button:hover {
              opacity: 0.9;
          }

          .clear-button {
              background-color: var(--danger);
          }

          .mail-button {
              background-color: var(--secondary);
          }

          .date-filter {
              margin: 20px 0;
              display: flex;
              align-items: center;
              gap: 10px;
              flex-wrap: wrap;
          }

          .date-filter input[type="date"] {
              padding: 8px;
              border-radius: 4px;
              border: 1px solid #ddd;
              min-width: 150px;
          }

          .price-input {
              margin: 20px 0;
              display: flex;
              align-items: center;
              gap: 10px;
          }

          #pricePerKwh {
              padding: 8px;
              border-radius: 4px;
              border: 1px solid #ddd;
              width: 80px;
          }

          table {
              width: 100%;
              border-collapse: collapse;
              margin: 20px 0;
          }

          th, td {
              border: 1px solid #ddd;
              padding: 12px;
              text-align: left;
          }

          th {
              background-color: var(--primary);
              color: white;
          }

          tr:nth-child(even) {
              background-color: var(--light);
          }

          .preview-container {
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
              margin: 10px 0;
          }

          .preview-image {
              width: 150px;
              height: 150px;
              object-fit: contain;
              border: 1px solid #ddd;
              padding: 3px;
              border-radius: 4px;
          }

          #loadingIndicator {
              display: none;
              text-align: center;
              margin: 10px 0;
              padding: 10px;
              background-color: var(--light);
              border-radius: 4px;
          }

          .error-message {
              color: var(--danger);
              display: none;
              margin: 10px 0;
              padding: 10px;
              background-color: #ffebee;
              border: 1px solid #ffcdd2;
              border-radius: 4px;
          }

          @media (max-width: 600px) {
              .container {
                  padding: 10px;
              }

              table {
                  font-size: 14px;
              }

              th, td {
                  padding: 8px;
              }

              .preview-image {
                  width: 100px;
                  height: 100px;
              }

              .date-filter {
                  flex-direction: column;
                  align-items: flex-start;
              }

              .date-filter input[type="date"] {
                  width: 100%;
              }
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="logo-container">
              <svg class="logo" width="512" height="512" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect width="512" height="512" rx="128" fill="#E91E63"/>
                  <path d="M256 112c-88.366 0-160 71.634-160 160s71.634 160 160 160 160-71.634 160-160S344.366 112 256 112zm0 40c66.274 0 120 53.726 120 120s-53.726 120-120 120-120-53.726-120-120 53.726-120 120-120z" fill="white"/>
                  <path d="M288 232h-64l-32 96h64l-16 72 112-120h-64l32-48z" fill="white"/>
                  <path d="M256 172c-55.228 0-100 44.772-100 100s44.772 100 100 100 100-44.772 100-100-44.772-100-100-100zm0 40c33.137 0 60 26.863 60 60s-26.863 60-60 60-60-26.863-60-60 26.863-60 60-60z" fill="white" fill-opacity="0.3"/>
              </svg>
          </div>

          <h1>NCubed Laadkosten</h1>
          
          <div class="upload-container" id="dropZone">
              <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
              <button onclick="document.getElementById('photoInput').click()">Upload Screenshot(s)</button>
              <p>Of sleep afbeeldingen hierheen</p>
              <div id="previewContainer" class="preview-container"></div>
          </div>

          <button onclick="clearAll()" class="clear-button">Clear Alles</button>

          <div id="error" class="error-message"></div>
          <div id="loadingIndicator">Bezig met verwerken...</div>

          <div class="price-input">
              <label for="pricePerKwh">Prijs per kWh: €</label>
              <input type="number" id="pricePerKwh" value="0.35" step="0.01" min="0" onchange="updateTable()">
          </div>

          <div class="date-filter">
              <label for="startDate">Van:</label>
              <input type="date" id="startDate" onchange="updateTable()">
              <label for="endDate">Tot:</label>
              <input type="date" id="endDate" onchange="updateTable()">
          </div>
          
          <div id="invoiceContainer">
              <h2>Laadkosten Overzicht</h2>
              <p><strong>Kenteken: HKX-39-V</strong></p>
              <table id="invoiceTable">
                  <thead>
                      <tr>
                          <th>Datum</th>
                          <th>Omschrijving</th>
                          <th>kWh</th>
                          <th>Prijs per kWh</th>
                          <th>Bedrag</th>
                      </tr>
                  </thead>
                  <tbody id="invoiceBody"></tbody>
              </table>
              <p>Totaalbedrag: <span id="invoiceTotal">€0,00</span></p>
              <button onclick="generatePDF()">Download PDF</button>
              <button onclick="sendEmailOnly()" class="mail-button">Verstuur Mail</button>
          </div>
      </div>
      <script>
          const MONICA_API_KEY = 'sk-74PDyAlNKWSTMSF00qpvh0Z0WuGzpriVmWDBdMAUHED9PSmGLcMCZ4ByElHRwX7ch8wgghmnusYT2Zcb2QLpRbaG_heD';
          const IMGBB_API_KEY = '56fb3a05b4ed17c9e72b3cfb52caddb8';
          
          const dropZone = document.getElementById('dropZone');
          const photoInput = document.getElementById('photoInput');
          const loadingIndicator = document.getElementById('loadingIndicator');
          const errorElement = document.getElementById('error');
          let processedData = [];

          // Event Listeners
          dropZone.addEventListener('dragover', (e) => {
              e.preventDefault();
              dropZone.classList.add('dragover');
          });

          dropZone.addEventListener('dragleave', () => {
              dropZone.classList.remove('dragover');
          });

          dropZone.addEventListener('drop', (e) => {
              e.preventDefault();
              dropZone.classList.remove('dragover');
              handleFiles(e.dataTransfer.files);
          });

          photoInput.addEventListener('change', (e) => {
              handleFiles(e.target.files);
          });

          // Initialize date range and table on page load
          window.onload = function() {
              // Eerst de datums instellen
              const now = new Date();
              const currentDay = now.getDay();
              
              const monday = new Date(now);
              monday.setDate(now.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
              
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6);
              
              // Datums instellen in de input velden
              document.getElementById('startDate').value = formatDate(monday);
              document.getElementById('endDate').value = formatDate(sunday);
              
              // Direct de tabel updaten
              updateTable();
          };

          function formatDate(date) {
              const d = new Date(date);
              let month = '' + (d.getMonth() + 1);
              let day = '' + d.getDate();
              const year = d.getFullYear();

              if (month.length < 2) month = '0' + month;
              if (day.length < 2) day = '0' + day;

              return [year, month, day].join('-');
          }

          function clearAll() {
              document.getElementById('previewContainer').innerHTML = '';
              document.getElementById('invoiceBody').innerHTML = '';
              document.getElementById('invoiceTotal').textContent = '€0,00';
              processedData = [];
              photoInput.value = '';
              const now = new Date();
              document.getElementById('startDate').value = formatDate(now);
              document.getElementById('endDate').value = formatDate(now);
              updateTable();
          }

          function updateTable() {
              const invoiceBody = document.getElementById('invoiceBody');
              const startDate = new Date(document.getElementById('startDate').value);
              const endDate = new Date(document.getElementById('endDate').value);
              endDate.setHours(23, 59, 59);
              
              let tableContent = '';
              let totalAmount = 0;
              const pricePerKwh = parseFloat(document.getElementById('pricePerKwh').value);

              // Voorbeelddata voor de huidige week
              const sampleData = [
                  { date: '22-04-2024', kwh: 12.5 },
                  { date: '24-04-2024', kwh: 15.2 },
                  { date: '26-04-2024', kwh: 18.7 }
              ];

              // Genereer tabelrijen voor de voorbeelddata
              sampleData.forEach(item => {
                  const [day, month, year] = item.date.split('-');
                  const rowDate = new Date(year, month - 1, day);
                  
                  if (rowDate >= startDate && rowDate <= endDate) {
                      const amount = item.kwh * pricePerKwh;
                      totalAmount += amount;
                      
                      tableContent += `
                          <tr>
                              <td>${item.date}</td>
                              <td>Thuisladen elektrische auto (HKX-39-V)</td>
                              <td>${item.kwh.toFixed(2)}</td>
                              <td>€${pricePerKwh.toFixed(2)}</td>
                              <td>€${amount.toFixed(2)}</td>
                          </tr>
                      `;
                  }
              });

              // Voeg eventuele verwerkte data toe
              processedData.forEach(content => {
                  const lines = content.split('\n');
                  lines.forEach(line => {
                      if (line.includes(',')) {
                          const [date, kwh] = line.split(',').map(item => item.trim());
                          const kwhValue = parseFloat(kwh);
                          if (!isNaN(kwhValue)) {
                              const [day, month, year] = date.split('-');
                              const rowDate = new Date(year, month - 1, day);
                              
                              if (rowDate >= startDate && rowDate <= endDate) {
                                  const amount = kwhValue * pricePerKwh;
                                  totalAmount += amount;
                                  
                                  tableContent += `
                                      <tr>
                                          <td>${date}</td>
                                          <td>Thuisladen elektrische auto (HKX-39-V)</td>
                                          <td>${kwhValue.toFixed(2)}</td>
                                          <td>€${pricePerKwh.toFixed(2)}</td>
                                          <td>€${amount.toFixed(2)}</td>
                                      </tr>
                                  `;
                              }
                          }
                      }
                  });
              });

              // Update de tabel en het totaalbedrag
              invoiceBody.innerHTML = tableContent;
              document.getElementById('invoiceTotal').textContent = `€${totalAmount.toFixed(2)}`;
          }

          async function handleFiles(files) {
              const previewContainer = document.getElementById('previewContainer');
              
              for (const file of files) {
                  if (file.type.startsWith('image/')) {
                      try {
                          const reader = new FileReader();
                          
                          reader.onload = async (e) => {
                              const img = document.createElement('img');
                              img.src = e.target.result;
                              img.className = 'preview-image';
                              previewContainer.appendChild(img);
                              
                              await processImage(e.target.result);
                          };
                          
                          reader.readAsDataURL(file);
                      } catch (error) {
                          showError(`Fout bij verwerken van bestand: ${file.name}`);
                      }
                  }
              }
          }

          async function processImage(imageData) {
              try {
                  loadingIndicator.style.display = 'block';
                  errorElement.style.display = 'none';
                  
                  const base64Image = imageData.split(',')[1];
                  const formData = new FormData();
                  formData.append('image', base64Image);
                  
                  const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                      method: 'POST',
                      body: formData
                  });
                  
                  if (!uploadResponse.ok) {
                      throw new Error('Fout bij uploaden afbeelding');
                  }
                  
                  const uploadResult = await uploadResponse.json();
                  const imageUrl = uploadResult.data.url;
                  
                  const response = await fetch('https://old-voice-773e.r-lutjenkossink.workers.dev/monica', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${MONICA_API_KEY}`
                      },
                      body: JSON.stringify({
                          model: "gpt-4o",
                          messages: [{
                              role: "user",
                              content: [
                                  {
                                      type: "text",
                                      text: "Analyseer deze laadsessie. Geef alleen de thuislaadsessies. Format per sessie: datum, kWh"
                                  },
                                  {
                                      type: "image_url",
                                      image_url: {
                                          url: imageUrl
                                      }
                                  }
                              ]
                          }]
                      })
                  });

                  if (!response.ok) {
                      throw new Error('Fout bij analyse van de afbeelding');
                  }
                  
                  const data = await response.json();
                  processedData.push(data.choices[0].message.content);
                  updateTable();
                  
              } catch (error) {
                  console.error('Error:', error);
                  showError('Fout bij verwerking: ' + error.message);
              } finally {
                  loadingIndicator.style.display = 'none';
              }
          }

          function showError(message) {
              errorElement.textContent = message;
              errorElement.style.display = 'block';
          }

          function generatePDF() {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              
              const startDate = new Date(document.getElementById('startDate').value);
              const endDate = new Date(document.getElementById('endDate').value);
              const formattedStartDate = startDate.toLocaleDateString('nl-NL');
              const formattedEndDate = endDate.toLocaleDateString('nl-NL');
              
              // Titel
              doc.setFontSize(16);
              doc.text('Laadkosten Overzicht', 20, 20);
              
              // Afzender informatie
              doc.setFontSize(10);
              doc.text([
                  'Afzender:',
                  'René Lutjenkossink',
                  'Wilhelminastraat 73',
                  '7001 GV Doetinchem',
                  'Tel: +31 (0)610750680',
                  'E-mail: rene.lutjenkossink@ncubed.nl',
                  'IBAN: NL21RABO 0370019466'
              ], 20, 35);
              
              // Ontvanger informatie
              doc.text([
                  'Ontvanger:',
                  'Ncubed B.V.',
                  'Van Deventerlaan 30-40',
                  '3528 AE Utrecht',
                  't.a.v. Rob Visser'
              ], 120, 35);
              
              // Factuurdetails
              doc.setFontSize(12);
              doc.text(`Periode: ${formattedStartDate} t/m ${formattedEndDate}`, 20, 85);
              doc.text(`Kenteken: HKX-39-V`, 20, 92);
              
              // Tabel
              doc.autoTable({
                  startY: 100,
                  head: [['Datum', 'Omschrijving', 'kWh', 'Prijs per kWh', 'Bedrag']],
                  body: Array.from(document.querySelectorAll('#invoiceBody tr')).map(row => 
                      Array.from(row.cells).map(cell => cell.textContent)
                  ),
                  headStyles: {
                      fillColor: [233, 30, 99],
                      textColor: [255, 255, 255]
                  }
              });
              
              doc.text(`Totaalbedrag: ${document.getElementById('invoiceTotal').textContent}`, 20, doc.lastAutoTable.finalY + 10);
              
              const dateStr = formattedStartDate.replace(/\//g, '-');
              doc.save(`Laadkosten_HKX-39-V_${dateStr}.pdf`);
          }

          function sendEmailOnly() {
              const startDate = new Date(document.getElementById('startDate').value);
              const endDate = new Date(document.getElementById('endDate').value);
              const formattedStartDate = startDate.toLocaleDateString('nl-NL');
              const formattedEndDate = endDate.toLocaleDateString('nl-NL');
              
              const filteredRows = Array.from(document.querySelectorAll('#invoiceBody tr'));
              const totalKwh = filteredRows.reduce((sum, row) => {
                  return sum + parseFloat(row.cells[2].textContent || 0);
              }, 0);
              
              const mailtoLink = `mailto:invoices@ncubed.nl?cc=rene.lutjenkossink@ncubed.nl
                  &subject=Laadkosten ${formattedStartDate} t/m ${formattedEndDate} (HKX-39-V)
                  &body=Beste,%0D%0A%0D%0A
                  Hierbij het overzicht van de laadkosten voor kenteken HKX-39-V.%0D%0A%0D%0A
                  Periode: ${formattedStartDate} t/m ${formattedEndDate}%0D%0A
                  Samenvatting:%0D%0A
                  - Totaal kWh: ${totalKwh.toFixed(2)}%0D%0A
                  - Totaalbedrag: ${document.getElementById('invoiceTotal').textContent}%0D%0A%0D%0A
                  Met vriendelijke groet,%0D%0A
                  René Lutjenkossink`.replace(/\s+/g, ' ');
              
              window.location.href = mailtoLink;
          }
      </script>
  </body>
  </html>
